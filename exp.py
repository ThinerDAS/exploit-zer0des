#!/usr/bin/python -i

from pwn import *

from hashlib import sha256
import desdifp

import string

host, port = '127.0.0.1', 10001
N = 1<<17#1 << 19
# 1<<17 is unstable, 1<<19 is stable

r = remote(host, port)

r.recvuntil('sha256(XXXX+')
suffix = r.recvuntil(') == ', drop=True)
target = r.recvline().strip()

# pure python bruteforce, slow!
# """
ans = util.iters.mbruteforce(lambda x: sha256(x+suffix).hexdigest()
                             == target, string.printable.strip(), 4, 'fixed')
# """
# ans='A.A>'
# don't know why, my deployment is without randomization
r.send(ans+'\n')
target = desdifp.genpair(N)
BATCH = 10000
enc = ''
for i in range(0, len(target), BATCH):
    print 'i', i, '/', len(target)
    pl = target[i:i+BATCH]
    r.recvuntil('plaintext(hex): ')
    r.send(pl.encode('hex')+'\n')
    enc += r.recvline().strip().decode('hex')
context.log_level = 'debug'
r.recvuntil('plaintext(hex): ')
key = desdifp.crack(enc)
r.send('\n')
r.recvuntil('key(hex): ')
r.send(key.encode('hex')+'\n')

r.interactive()
